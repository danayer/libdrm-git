name: Update libdrm.spec

on:
  schedule:
    - cron: "0 0 * * *" # Запуск раз в день
  workflow_dispatch:     # Ручной запуск

jobs:
  update-spec:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest version and commit from upstream
        run: |
          # Получаем последний тег libdrm (только числа)
          LATEST_TAG=$(curl -s "https://gitlab.freedesktop.org/api/v4/projects/mesa%2Fdrm/repository/tags" \
                        | jq -r '.[0].name' | grep -oP '\d+\.\d+\.\d+')
          LATEST_LIB_VERSION=$(echo "$LATEST_TAG" | cut -d'.' -f3)

          # Получаем последний коммит
          LATEST_COMMIT=$(curl -s "https://gitlab.freedesktop.org/api/v4/projects/mesa%2Fdrm/repository/commits" \
                        | jq -r '.[0].id')
          SHORTCOMMIT=${LATEST_COMMIT:0:7}

          echo "LATEST_LIB_VERSION=$LATEST_LIB_VERSION" >> $GITHUB_ENV
          echo "LATEST_COMMIT=$LATEST_COMMIT" >> $GITHUB_ENV
          echo "SHORTCOMMIT=$SHORTCOMMIT" >> $GITHUB_ENV

      - name: Check current lib_version
        run: |
          CURRENT_LIB_VERSION=$(grep -oP '^%global lib_version\s+\K\d+' libdrm.spec)
          CURRENT_COMMIT=$(grep -oP '^%global commit\s+\K\w+' libdrm.spec)

          if [ "$CURRENT_LIB_VERSION" != "$LATEST_LIB_VERSION" ] || [ "$CURRENT_COMMIT" != "$LATEST_COMMIT" ]; then
            echo "UPDATE_NEEDED=true" >> $GITHUB_ENV
          else
            echo "UPDATE_NEEDED=false" >> $GITHUB_ENV
          fi

      - name: Update spec file
        if: env.UPDATE_NEEDED == 'true'
        run: |
          sed -i "s/^%global lib_version .*/%global lib_version $LATEST_LIB_VERSION/" libdrm.spec
          sed -i "s/^%global commit .*/%global commit $LATEST_COMMIT/" libdrm.spec
          sed -i "s/^%global shortcommit .*/%global shortcommit $SHORTCOMMIT/" libdrm.spec

      - name: Commit and push changes
        if: env.UPDATE_NEEDED == 'true'
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git add libdrm.spec
          git commit -m "Update libdrm: lib_version $LATEST_LIB_VERSION, commit $SHORTCOMMIT"
          git push origin HEAD:${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
