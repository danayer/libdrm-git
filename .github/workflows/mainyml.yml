name: Update libdrm.spec

on:
  schedule:
    - cron: "0 0 * * *"   # раз в день
  workflow_dispatch:

jobs:
  update-spec:
    runs-on: ubuntu-24.04
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest libdrm version and commit from GitLab
        run: |
          TAG=$(curl -s "https://gitlab.freedesktop.org/api/v4/projects/mesa%2Fdrm/repository/tags" \
            | jq -r '.[].name' \
            | grep '^libdrm-' \
            | head -n1)

          if [ -z "$TAG" ]; then
            echo "Failed to fetch libdrm tag"
            exit 1
          fi

          # libdrm-X.Y.Z → Z
          LIB_VERSION=$(echo "$TAG" | sed 's/^libdrm-[0-9]\+\.[0-9]\+\.//')

          COMMIT=$(curl -s "https://gitlab.freedesktop.org/api/v4/projects/mesa%2Fdrm/repository/commits" \
            | jq -r '.[0].id')

          if [ -z "$COMMIT" ]; then
            echo "Failed to fetch commit"
            exit 1
          fi

          echo "LIB_VERSION=$LIB_VERSION" >> "$GITHUB_ENV"
          echo "COMMIT=$COMMIT" >> "$GITHUB_ENV"
          echo "SHORTCOMMIT=${COMMIT:0:7}" >> "$GITHUB_ENV"

      - name: Check current spec and calculate new version
        run: |
          OLD_LIB_VERSION=$(sed -n 's/^%global[[:space:]]\+lib_version[[:space:]]\+\([0-9]\+\).*/\1/p' libdrm.spec)
          OLD_COMMIT=$(sed -n 's/^%global[[:space:]]\+commit[[:space:]]\+\([a-f0-9]\+\).*/\1/p' libdrm.spec)

          CURRENT_VERSION=$(sed -n 's/^[[:space:]]*Version:[[:space:]]*2\.4\.%{lib_version}\.\([0-9]\+\).*/\1/p' libdrm.spec)

          if [ -z "$CURRENT_VERSION" ]; then
            CURRENT_VERSION=0
          fi

          if [ "$LIB_VERSION" != "$OLD_LIB_VERSION" ] || [ "$COMMIT" != "$OLD_COMMIT" ]; then
            NEW_SUBVERSION=$((CURRENT_VERSION + 1))
            echo "UPDATE_NEEDED=true" >> "$GITHUB_ENV"
          else
            NEW_SUBVERSION="$CURRENT_VERSION"
            echo "UPDATE_NEEDED=false" >> "$GITHUB_ENV"
          fi

          echo "NEW_SUBVERSION=$NEW_SUBVERSION" >> "$GITHUB_ENV"

      - name: Update libdrm.spec
        if: env.UPDATE_NEEDED == 'true'
        run: |
          sed -i "s/^%global[[:space:]]\+lib_version.*/%global lib_version $LIB_VERSION/" libdrm.spec
          sed -i "s/^%global[[:space:]]\+commit.*/%global commit $COMMIT/" libdrm.spec
          sed -i "s/^%global[[:space:]]\+shortcommit.*/%global shortcommit $SHORTCOMMIT/" libdrm.spec
          sed -i "s/^[[:space:]]*Version:.*/Version:        2.4.%{lib_version}.$NEW_SUBVERSION/" libdrm.spec

      - name: Commit and push changes
        if: env.UPDATE_NEEDED == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          git add libdrm.spec
          git commit -m "Update libdrm.spec to libdrm-$LIB_VERSION ($SHORTCOMMIT)"
          git push
